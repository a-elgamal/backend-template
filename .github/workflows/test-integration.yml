name: Test Integration

on: 
  push:
    paths:
      - .github/workflows/test-integration.yml
      - 'portal/**'
      - '**.go'

env:
  test_badge_color: red
  test_badge_message: Failed

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: myservice
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    if: ${{ !startsWith( github.ref, 'refs/tags/' ) }}

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      
      - name: Setup Golang
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Start Server
        run: make run &
      
      - name: Start Chrome Driver
        run: chromedriver --port=4444 &

      - name: Set up Flutter SDK
        uses: flutter-actions/setup-flutter@v3
        with:
          channel: stable
          version: latest
          cache: true
          cache-sdk: true
          cache-key: ${{ hashFiles('portal/pubspec.lock') }}
          
      - name: Install dependencies
        working-directory: portal
        run: flutter pub get
      
      - name: Run Apps Integration Tests
        working-directory: portal
        run: flutter drive --target=integration_test/integration.dart --web-port=8000 -d web-server

      - name: All tests pass?
        if: success()
        run: |
          echo "test_badge_color=brightgreen" >> $GITHUB_ENV
          echo "test_badge_message=Passed" >> $GITHUB_ENV

      - name: Create tests badge
        if: (success() || failure()) && secrets.GIST_TOKEN != ''
        uses: schneegans/dynamic-badges-action@v1.6.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: 9db84bf86640df151185b96b762b6c1e
          filename: "myservice-integration-tests.json"
          label: 'Integration Tests'
          message: '${{ env.test_badge_message }}'
          namedLogo: "rotaryinternational"
          color: ${{ env.test_badge_color }}
          forceUpdate: true